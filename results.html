<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>黑暗人格测试结果</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: 'Arial', sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f9f9f9;
        }
        h1, h2 { 
            color: #333; 
            text-align: center;
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            margin-top: 25px; 
        }
        .subtitle {
            color: #666;
            margin-bottom: 10px;
            text-align: center;
        }
        .d-value-display {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin: 15px 0;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 10px;
            text-align: center;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chart-container { 
            width: 90%; 
            max-width: 700px; 
            height: 500px;
            margin: 30px auto; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 20px; 
            background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
        }
        .button-container {
            text-align: center;
            margin: 20px 0;
        }
        .action-button {
            display: inline-block;
            margin: 10px;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .action-button:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .magic-button {
            background-color: #e74c3c;
        }
        .magic-button:hover {
            background-color: #c0392b;
        }
        .error-message {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        /* 评语样式 */
        #commentary-output { 
            text-align: left; 
            margin: 20px auto 0;
            width: 90%; 
            max-width: 700px;
        }
        .dim-card { 
            border: 1px solid #ddd; 
            padding: 12px; 
            margin-bottom: 12px; 
            border-radius: 6px; 
            background-color: white;
            font-size: 0.9em;
        }
        .dim-card h3 { 
            margin-top: 0; 
            font-size: 1.1em;
            color: #2c3e50;
        }
        .advice { 
            font-style: italic; 
            color: #007bff; 
            margin-top: 8px; 
            padding-left: 8px;
            border-left: 3px solid #007bff;
            font-size: 0.9em;
        }
        .low-score { 
            background-color: #e6ffe6; 
            border-left: 5px solid #4CAF50; 
        }
        .mid-score { 
            background-color: #fffbe6; 
            border-left: 5px solid #FFC107; 
        }
        .high-score { 
            background-color: #ffe6e6; 
            border-left: 5px solid #F44336; 
        }
        .percentage-display {
            font-weight: bold;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .highlight-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #6c757d;
        }
        
        /* 角色头像样式 */
        .character {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 20px;
            width: 150px;
        }
        .character-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }
        .magic-avatar {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: 4px solid #e74c3c;
        }
        .spirit-avatar {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: 4px solid #3498db;
        }
        .character-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1.2em;
        }
        
        /* 平面立体饼图样式 */
        .flat-pie-container {
            width: 300px;
            height: 300px;
            margin: 0 auto;
            position: relative;
        }
        .flat-pie {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #4d94ff 0deg,
                #4d94ff calc(var(--spirit-percent) * 3.6deg),
                #ff4d4d calc(var(--spirit-percent) * 3.6deg),
                #ff4d4d 360deg
            );
            box-shadow: 
                0 10px 20px rgba(0,0,0,0.2),
                inset 0 0 20px rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }
        .flat-pie::before {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 30%;
            height: 30%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent 70%);
            filter: blur(5px);
            opacity: 0.7;
        }
        .flat-pie::after {
            content: '';
            position: absolute;
            bottom: 10%;
            right: 10%;
            width: 40%;
            height: 40%;
            border-radius: 50%;
            background: radial-gradient(circle at 70% 70%, rgba(0,0,0,0.2), transparent 70%);
            filter: blur(5px);
            opacity: 0.5;
        }
        
        /* 角色与手势组合 */
        .character-with-gesture {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }
        .character-gesture {
            font-size: 50px;
            margin: 0 15px;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
        }
        .magic-gesture {
            transform: rotate(90deg);
        }
        .spirit-gesture {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>

    <h1>综合测试结果分析</h1>
    <p class="subtitle">以下雷达图展示了您在10个黑暗人格维度上的得分和排名</p>
    
    <div id="dValueDisplay" class="d-value-display">
        我的D值：计算中...
    </div>

    <div class="chart-container">
        <canvas id="radarChart"></canvas>
    </div>
    
    <div class="button-container">
        <a href="test.html" class="action-button">返回重新测试</a>
        <button id="magicBallButton" class="action-button magic-button">查看您的魔丸属性</button>
    </div>
    
    <h2>关键维度分析与建议</h2>
    <div id="commentary-output">
        <p>正在生成智能分析...</p>
    </div>
    
    <!-- 魔丸属性页面 (默认隐藏) -->
    <div id="magicBallPage" style="display: none;">
        <h1>您的魔丸属性分析</h1>
        <p class="subtitle">立体饼图展示了您的魔气与灵气属性分布</p>
        
        <div class="flat-pie-container">
            <div class="flat-pie" id="flatPie"></div>
        </div>
        
        <div id="characterContainer" style="text-align: center; margin: 20px 0;">
            <!-- 角色头像将通过JavaScript动态生成 -->
        </div>
        
        <div class="button-container">
            <button id="backToResults" class="action-button">返回结果分析</button>
        </div>
    </div>
    
    <script>
        // 检查Chart.js是否加载成功
        if (typeof Chart === 'undefined') {
            document.body.innerHTML = '<div class="error-message">错误：Chart.js库加载失败，请检查网络连接。</div>';
            throw new Error('Chart.js not loaded');
        }

        // --- 核心数据定义 ---
        
        // 维度定义
        const DIMENSIONS = [
            'egoism', 'greed', 'mach', 'moral', 'narcissism',
            'power', 'psychopathy', 'sadism', 'selfcentered', 'spitefulness'
        ];
        
        // 维度标签 (用于图表的10个角)
        const dimensionLabels = [
            '利己主义', '贪婪', '马基雅维利主义', '道德推脱', '自恋',
            '心理权力', '精神变态', '施虐倾向', '自我为中心', '恶毒倾向'
        ];

        // --- 评语数据对象 (COMMENTARY_DATA) ---
        const COMMENTARY_DATA = {
            'egoism': {
                name: '利己主义',
                high: { 
                    title: "高分段 (高于70%)：倾向突出", 
                    comment: "您的自我需求被置于绝对首位，驱动力强。这可能带来追求目标的高效性，但极易导致您在团队协作中缺乏同理心，难以妥协，并可能因此破坏重要的人际关系。", 
                    advice: "建议有意识地练习换位思考，在做重要决策时，评估您的行为对至少两位重要他人的潜在影响。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：平衡发展", 
                    comment: "您在自我利益和他人需求之间表现出一定的平衡。您能在维护自身权益的同时，保持合作意愿。在竞争激烈时，可能略微倾向于自我保护。", 
                    advice: "建议在协作中明确表达自身立场，同时主动询问并考虑他人的观点，以提高领导力。" 
                },
                low: { 
                    title: "低分段 (低于40%)：合作优先", 
                    comment: "您的利己主义倾向非常弱。您具有高度的合作意愿和同理心，能够轻松为他人着想。这是一种积极的社会品质，但需要警惕过度牺牲个人时间或利益。", 
                    advice: "建议在帮助他人之前，先设立清晰的个人界限，确保自身精力充沛。" 
                }
            },
            'greed': {
                name: '贪婪',
                high: { 
                    title: "高分段 (高于70%)：物欲强烈", 
                    comment: "您的贪婪和物质欲望强烈，表现为对地位和财富的持续、强烈的渴求。这是一种强大的驱动力，能促使您取得成就，但可能使您难以享受现有成果，易陷入不道德的竞争。", 
                    advice: "建议定期练习'感恩日志'或回顾已有的成就，将注意力从'想要更多'转移到'珍惜拥有'上来平衡心态。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：典型进取心", 
                    comment: "您对财富和地位有健康的追求，是推动您进步的动力。您通常不会为了物质利益做出极端的牺牲，但在资源有限时可能会感到焦虑。", 
                    advice: "建议设定清晰、可量化的目标，以引导您的进取心，而不是让它成为无止境的欲望。" 
                },
                low: { 
                    title: "低分段 (低于40%)：知足淡泊", 
                    comment: "您的物欲倾向很低，表现出知足和对物质的淡然。这让您心态平和，不容易被外界的浮华所困扰。但如果得分过低，可能意味着缺乏必要的雄心壮志。", 
                    advice: "建议将'成就感'的定义扩展到非物质领域（如知识、人际连接），以激发您的内在驱动力。" 
                }
            },
            'mach': {
                name: '马基雅维利主义',
                high: { 
                    title: "高分段 (高于70%)：策略操作者", 
                    comment: "您的马基雅维利主义特征明显，倾向于将人际互动视为一种策略游戏。您擅长伪装情绪、利用奉承和操纵手段来达到目的。这在高度竞争的环境中可能有效，但会严重损害您在人际关系中的信誉。", 
                    advice: "建议将策略能力用于建设性目标（如项目管理），并有意识地在关键关系中保持完全的透明和真诚。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：适度谨慎", 
                    comment: "您有识别和理解社会策略的能力，但在日常互动中并不经常使用。您能保持理性，但在面对高风险利益时，可能会倾向于策略性地隐藏信息。", 
                    advice: "建议培养'策略意识'，学会在不使用的情况下识别操纵行为，保护自己免受剥削。" 
                },
                low: { 
                    title: "低分段 (低于40%)：坦诚直率", 
                    comment: "您在人际交往中倾向于坦诚和直率，非常重视透明度。您可能不擅长权谋，且容易相信他人，这体现了高尚的品格。", 
                    advice: "建议学会设定必要的防御界限，以保护自己在复杂环境中不被他人利用。" 
                }
            },
            'moral': {
                name: '道德推脱',
                high: { 
                    title: "高分段 (高于70%)：规则灵活", 
                    comment: "您倾向于在特殊情况下为自己的行为寻找理由，认为道德规范具有弹性或不适用于自己。这可以帮助您快速做出决策并规避责任，但长期下来会损害您的正直形象。", 
                    advice: "建议在违背规则前，进行明确的道德成本评估，并为自己的行为承担全部责任。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：情境驱动", 
                    comment: "您通常遵守规则，但在压力或利益诱惑下，可能会寻找借口或将责任推给外部环境。您的道德底线清晰，但不完全坚固。", 
                    advice: "建议在重大压力下，主动寻求他人的观点，避免自我合理化。" 
                },
                low: { 
                    title: "低分段 (低于40%)：坚守原则", 
                    comment: "您具有高度的自律和责任感，坚信原则的重要性。您很少为自己的错误行为找借口，并能承担全部责任。", 
                    advice: "建议认识到过于僵化的原则可能会在某些灰色地带阻碍创新，允许在合乎法律和人性的前提下进行灵活思考。" 
                }
            },
            'narcissism': {
                name: '自恋',
                high: { 
                    title: "高分段 (高于70%)：自我中心放大", 
                    comment: "您强烈渴望成为关注的焦点，并坚信自己比大多数人更有天赋和价值。这为您带来了巨大的自信和领导欲望，但可能导致您对他人的感受和成就缺乏关注，难以接受批评。", 
                    advice: "建议将展示成就的欲望转化为指导和激励他人的力量，并将自我价值建立在实际贡献而非外部赞美上。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：健康自信", 
                    comment: "您拥有健康的自信和自我肯定，希望得到他人的认可。您能够在追求个人目标时尊重他人，但在面对批评时，可能会表现出短暂的不适。", 
                    advice: "建议在寻求赞美的同时，主动给予他人反馈和支持，以建立互惠的人际关系。" 
                },
                low: { 
                    title: "低分段 (低于40%)：谦逊内敛", 
                    comment: "您的自恋倾向很低，表现出谦逊和内敛。您倾向于低估自己的价值，不愿意成为关注的焦点。这有助于您进行深刻的自我反思。", 
                    advice: "建议主动承认和展示自己的成就，确保您的才能不会因为过度谦逊而被忽视。" 
                }
            },
            'power': {
                name: '心理权力',
                high: { 
                    title: "高分段 (高于70%)：控制欲强", 
                    comment: "您对权威和控制力有强烈的偏好，享受支配谈话和成为决策者的感觉。这使您成为一位果断的领导者，但可能在团队中显得过于独断专行，抑制他人创造力。", 
                    advice: "建议学习授权和放权，将控制力转化为影响力，培养团队的自主性。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：适度影响力", 
                    comment: "您渴望在重要的决策中拥有发言权和影响力。您在必要时能够掌控局面，但也愿意听取他人的意见和妥协。", 
                    advice: "建议在不同情境中灵活调整领导风格，既能果断决策，也能作为支持者。" 
                },
                low: { 
                    title: "低分段 (低于40%)：权力淡薄", 
                    comment: "您对权力和控制的渴望很弱，更喜欢协作和平等的环境。您容易成为优秀的执行者和支持者，但可能在需要果断领导时犹豫不决。", 
                    advice: "建议在团队需要时，主动站出来承担决策责任，增强自己的决断力。" 
                }
            },
            'psychopathy': {
                name: '精神变态',
                high: { 
                    title: "高分段 (高于70%)：缺乏情感连接", 
                    comment: "您很少感到懊悔或内疚，对他人痛苦的敏感度低。您可能具有无畏和专注于目标的优点，但这种情感的缺乏会严重阻碍您建立长期、有意义的人际关系。", 
                    advice: "建议有意识地练习识别和命名他人的情绪，并通过服务或志愿活动来增加同理心体验。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：高风险意识", 
                    comment: "您通常能感受情绪，但倾向于规避深度情感投入。您可能对风险有一定的偏好，能够快速从错误中抽离。", 
                    advice: "建议评估行为的长期后果，而不是仅仅关注眼前的刺激或收益。" 
                },
                low: { 
                    title: "低分段 (低于40%)：情感丰富", 
                    comment: "您的情感反应强烈，富有同情心，很容易感受到内疚和懊悔。这是一种极高的社会情感能力。", 
                    advice: "建议在做出理性决策时，不要让过度的情感困扰占据主导地位，学会适当的情绪抽离。" 
                }
            },
            'sadism': {
                name: '施虐倾向',
                high: { 
                    title: "高分段 (高于70%)：享受伤害", 
                    comment: "您从他人痛苦、失败或受挫中获得满足感。这是一种破坏性倾向，虽然能带来短期的优势或快感，但会使您被视为危险人物，最终导致关系破裂和社会排斥。", 
                    advice: "建议将攻击性转化为积极的竞争能量，并通过幽默和建设性的方式来表达不满，而非直接的伤害行为。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：竞争性强", 
                    comment: "您在竞争中享受胜利的快感，偶尔会过度批评他人，但不以看到他人的痛苦为主要目的。", 
                    advice: "建议将批评集中在行为和表现上，而不是针对个人，以保持建设性。" 
                },
                low: { 
                    title: "低分段 (低于40%)：友善和气", 
                    comment: "您表现出高度的友好和同情心，不愿看到他人受苦。这为您赢得了良好的声誉。", 
                    advice: "建议学会为自己辩护和坚持立场，避免过度迁就他人。" 
                }
            },
            'selfcentered': {
                name: '自我为中心',
                high: { 
                    title: "高分段 (高于70%)：视角狭隘", 
                    comment: "您习惯于将世界的焦点集中在自己的感受和需求上，难以理解或接受他人的不同观点。这可能导致您忽略他人的有效建议，并引起严重的沟通障碍。", 
                    advice: "建议在沟通中主动询问他人的意见，并用至少三分钟的时间去理解他们的立场，即使你不同意。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：焦点转移", 
                    comment: "您通常能够理解他人的观点，但在压力或感到不被重视时，会倾向于将讨论的焦点拉回到自己身上。", 
                    advice: "建议在团队讨论时，主动将发言机会留给别人，并学习倾听。" 
                },
                low: { 
                    title: "低分段 (低于40%)：关注他人", 
                    comment: "您能够轻松地理解并关注他人的需求和感受，表现出良好的适应性和倾听能力。", 
                    advice: "建议在人际互动中，明确表达自身的想法和需求，以实现双向沟通。" 
                }
            },
            'spitefulness': {
                name: '恶毒倾向',
                high: { 
                    title: "高分段 (高于70%)：恶意嫉妒", 
                    comment: "您表现出明显的恶意，可能因为嫉妒而希望或试图破坏他人的成功。这种倾向会使您的行为具有破坏性，带来报复和人际冲突。", 
                    advice: "建议专注于自身的发展，将对他人成功的负面反应转化为自我提升的动力。" 
                },
                medium: { 
                    title: "中分段 (40%-70%)：偶尔不悦", 
                    comment: "您通常能够控制负面情绪，但在受到冒犯或感到不公时，可能会产生怨恨或散布负面信息。", 
                    advice: "建议通过直接、建设性的方式解决冲突，避免通过散布谣言来表达不满。" 
                },
                low: { 
                    title: "低分段 (低于40%)：宽容友善", 
                    comment: "您的恶毒倾向很低，表现出宽容和同情心，对他人怀有善意。", 
                    advice: "建议学会保护自己免受恶意攻击，并设定适当的防御界限。" 
                }
            }
        };

        // 全局变量存储D值
        let dValue = 0;

        // --- 主函数 ---
        function initializeChart() {
            const urlParams = new URLSearchParams(window.location.search);

            // 检查是否有数据
            if (urlParams.toString().length === 0) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px;">
                        <h2>没有测试数据</h2>
                        <p>请先完成测试</p>
                        <a href="test.html" class="action-button">前往测试</a>
                    </div>
                `;
                return;
            }

            // 存储最终结果的两个数组
            const userScorePercentages = [];
            const userRankings = [];
            const COMMENTARY_RESULTS = {}; // 用于存储最终的评语 HTML 文本
            const dimensionScores = []; // 用于存储维度名称和得分，以便排序

            // 常量用于分数标准化
            const MIN_SCORE = 7;
            const SCORE_RANGE = 28; // 35 - 7

            // 计算D值（所有维度得分的平均值）
            let totalScore = 0;
            let dimensionCount = 0;
            
            DIMENSIONS.forEach(dim => {
                // 提取原始得分
                const rawScore = parseInt(urlParams.get(`score_${dim}`) || 0); 
                
                // 提取排名百分比
                const rankPercent = parseInt(urlParams.get(`rank_${dim}`) || 0);

                // 存储排名数据
                userRankings.push(rankPercent);
                
                // 将原始分数转换为百分比 (0-100)
                const scorePercent = Math.round(((rawScore - MIN_SCORE) / SCORE_RANGE) * 100);
                
                // 存储用户得分百分比
                userScorePercentages.push(scorePercent);
                
                // 累加得分用于计算D值
                totalScore += scorePercent;
                dimensionCount++;
                
                // 存储维度名称和得分，用于排序
                dimensionScores.push({
                    dimension: dim,
                    score: scorePercent
                });
                
                // --- 动态生成评语逻辑 ---
                let tierData;
                let tierClass;
                
                if (scorePercent > 70) {
                    tierData = COMMENTARY_DATA[dim].high;
                    tierClass = 'high-score';
                } else if (scorePercent >= 40) {
                    tierData = COMMENTARY_DATA[dim].medium;
                    tierClass = 'mid-score';
                } else {
                    tierData = COMMENTARY_DATA[dim].low;
                    tierClass = 'low-score';
                }
                
                // 构建评语 HTML 块
                const percentageDisplay = `得分: ${scorePercent}% | 排名: ${rankPercent}%`;

                COMMENTARY_RESULTS[dim] = `
                    <div class="dim-card ${tierClass}">
                        <h3>${COMMENTARY_DATA[dim].name} - ${tierData.title}</h3>
                        <p class="percentage-display">${percentageDisplay}</p>
                        <p>${tierData.comment}</p>
                        <p class="advice"><strong>建议:</strong> ${tierData.advice}</p>
                    </div>
                `;
                // --- 评语逻辑结束 ---
            });

            // 计算D值（所有维度得分的平均值）
            dValue = Math.round(totalScore / dimensionCount);
            
            // 显示D值
            document.getElementById('dValueDisplay').textContent = `我的D值：${dValue}%`;

            // --- Chart.js 绘图配置 ---

            const ctx = document.getElementById('radarChart');

            // 确保canvas元素存在
            if (!ctx) {
                document.body.innerHTML += '<div class="error-message">错误：无法找到canvas元素。</div>';
                return;
            }

            try {
                const config = {
                    type: 'radar',
                    data: {
                        labels: dimensionLabels,
                        datasets: [{
                            label: '我的得分',
                            data: userScorePercentages, 
                            backgroundColor: 'rgba(255, 182, 193, 0.4)',
                            borderColor: 'rgb(255, 105, 180)',
                            pointBackgroundColor: 'rgb(255, 105, 180)',
                            pointBorderColor: '#fff',
                            pointRadius: 4,
                            borderWidth: 2
                        }, {
                            label: '我的排名',
                            data: userRankings, 
                            backgroundColor: 'rgba(54, 162, 235, 0.4)', 
                            borderColor: 'rgb(54, 162, 235)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointRadius: 4,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                suggestedMin: 0,
                                suggestedMax: 100,
                                ticks: {
                                    stepSize: 10,
                                    callback: function(value) {
                                        return value + '%'; 
                                    },
                                    backdropColor: 'rgba(255, 255, 255, 0.8)'
                                },
                                pointLabels: {
                                    font: {
                                        size: 13,
                                        weight: 'bold'
                                    },
                                    color: '#333'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        size: 14
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.raw + '%';
                                    }
                                }
                            }
                        }
                    }
                };

                // 绘制图表
                new Chart(ctx, config);
                
                // --- 选择并展示关键维度评语 ---
                const commentaryOutput = document.getElementById('commentary-output');
                
                // 按得分排序维度
                dimensionScores.sort((a, b) => b.score - a.score);
                
                // 选择两个最高分和一个最低分
                const topDimensions = dimensionScores.slice(0, 2); // 两个最高分
                const bottomDimension = dimensionScores[dimensionScores.length - 1]; // 一个最低分
                
                // 构建评语HTML
                let fullCommentaryHTML = '';
                
                // 添加最高分维度评语
                if (topDimensions.length > 0) {
                    fullCommentaryHTML += '<div class="highlight-section">';
                    fullCommentaryHTML += '<h3 style="margin-top: 0;">最突出的维度</h3>';
                    topDimensions.forEach(item => {
                        fullCommentaryHTML += COMMENTARY_RESULTS[item.dimension];
                    });
                    fullCommentaryHTML += '</div>';
                }
                
                // 添加最低分维度评语
                if (bottomDimension && !topDimensions.includes(bottomDimension)) {
                    fullCommentaryHTML += '<div class="highlight-section">';
                    fullCommentaryHTML += '<h3 style="margin-top: 0;">最不突出的维度</h3>';
                    fullCommentaryHTML += COMMENTARY_RESULTS[bottomDimension.dimension];
                    fullCommentaryHTML += '</div>';
                }

                commentaryOutput.innerHTML = fullCommentaryHTML;
                
            } catch (error) {
                console.error('图表绘制错误:', error);
                document.body.innerHTML += `<div class="error-message">图表绘制错误: ${error.message}</div>`;
            }
        }

        // 创建魔丸属性饼状图
        function createMagicBallChart() {
            const spiritValue = 100 - dValue;
            
            // 设置饼图颜色比例（对调颜色：红色在左，蓝色在右）
            const pieElement = document.getElementById('flatPie');
            pieElement.style.setProperty('--spirit-percent', spiritValue);
            
            // 根据魔气值和灵气值的比例显示不同的角色表情
            const characterContainer = document.getElementById('characterContainer');
            let magicFace, spiritFace;
            
            if (dValue > spiritValue) {
                // 魔气值大于灵气值
                magicFace = '😄';
                spiritFace = '😔';
            } else if (dValue < spiritValue) {
                // 魔气值小于灵气值
                magicFace = '😔';
                spiritFace = '😄';
            } else {
                // 魔气值等于灵气值
                magicFace = '😤';
                spiritFace = '😤';
            }
            
            // 创建角色头像HTML，按照要求调整手势位置和方向
            characterContainer.innerHTML = `
                <div style="display: flex; justify-content: space-around; align-items: center; margin: 20px 0; flex-wrap: wrap;">
                    <!-- 魔气值在左侧，手势在表情右侧 -->
                    <div class="character">
                        <div class="character-with-gesture">
                            <div class="character-avatar magic-avatar">
                                ${magicFace}
                            </div>
                            <div class="character-gesture magic-gesture">✊</div>
                        </div>
                        <div class="character-name">魔气值</div>
                    </div>
                    
                    <!-- 灵气值在右侧，手势在表情左侧 -->
                    <div class="character">
                        <div class="character-with-gesture">
                            <div class="character-gesture spirit-gesture">✌️</div>
                            <div class="character-avatar spirit-avatar">
                                ${spiritFace}
                            </div>
                        </div>
                        <div class="character-name">灵气值</div>
                    </div>
                </div>
            `;
        }
        
        // 页面切换功能
        document.getElementById('magicBallButton').addEventListener('click', function() {
            document.querySelector('body > h1').style.display = 'none';
            document.querySelector('.subtitle').style.display = 'none';
            document.getElementById('dValueDisplay').style.display = 'none';
            document.querySelector('.chart-container').style.display = 'none';
            document.querySelector('.button-container').style.display = 'none';
            document.querySelector('h2').style.display = 'none';
            document.getElementById('commentary-output').style.display = 'none';
            
            document.getElementById('magicBallPage').style.display = 'block';
            createMagicBallChart();
        });
        
        document.getElementById('backToResults').addEventListener('click', function() {
            document.getElementById('magicBallPage').style.display = 'none';
            
            document.querySelector('body > h1').style.display = 'block';
            document.querySelector('.subtitle').style.display = 'block';
            document.getElementById('dValueDisplay').style.display = 'block';
            document.querySelector('.chart-container').style.display = 'block';
            document.querySelector('.button-container').style.display = 'block';
            document.querySelector('h2').style.display = 'block';
            document.getElementById('commentary-output').style.display = 'block';
        });

        // 页面加载完成后初始化图表
        document.addEventListener('DOMContentLoaded', initializeChart);
    </script>

</body>
</html>